<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åŒ£ä¹‹å›å“</title>
  <!-- æ‰€æœ‰å­—ä½“ï¼ˆé€šè¿‡ jsDelivr åŠ é€Ÿï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Source+Han+Serif+SC:wght@400;600&family=LXGW+WenKai+Screen&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;600&family=Fira+Code&display=swap" rel="stylesheet">
  <style id="theme-style"></style>
  <style id="season-style"></style>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--font-family, 'Source Han Serif SC');
      line-height: 1.7;
      transition: background-color 0.3s, color 0.3s;
      --font-size: 1rem; /* é»˜è®¤å­—å· */
    }

    /* === åŠ è½½åŠ¨ç”» === */
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 9999; transition: opacity 0.4s ease;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1.2s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* å¸ƒå±€ */
    #app { display: none; max-width: 1200px; margin: 0 auto; padding: 0.8rem; width: 100%; }
    #app.grid { display: grid; grid-template-columns: 0fr 1fr; gap: 0.5rem; transition: grid-template-columns 0.3s ease; }
    #sidebar { min-width: 220px; height: calc(100vh - 100px); }
    #sidebar.hidden { min-width: 0; width: 0; padding: 0; overflow: hidden; }

    /* ä¿®å¤ï¼šæ‰‹æœºç«¯ä¾§è¾¹æ è¦†ç›–æ•ˆæœ */
    #sidebar-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);
        z-index: 9998; display: none;
    }
    @media (max-width: 768px) {
        #app.grid { grid-template-columns: 1fr; }
        #sidebar { position: fixed; top: 0; left: -220px; z-index: 9999; height: 100vh; margin: 0; transition: left 0.3s ease; }
        #sidebar.shown { left: 0; }
        #sidebar.hidden { left: -220px; display: block; }
        #editor { z-index: 9997; }
    }

    /* é€šç”¨ */
    .card { padding: 1rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s ease; }
    .btn {
      padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
      position: relative; overflow: hidden;
    }
    .btn:hover { opacity: 0.9; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .btn:active { transform: scale(0.98); }
    .ripple {
      position: absolute; border-radius: 50%; background: rgba(255,255,255,0.4);
      transform: scale(0); animation: ripple 0.6s linear;
      pointer-events: none;
    }
    @keyframes ripple { to { transform: scale(4); opacity: 0; } }

    input, textarea { padding: 0.6rem; border-radius: 6px; border: 1px solid; font-family: inherit; font-size: var(--font-size); }
    h2 { margin-bottom: 1rem; font-size: 1.2rem; }

    /* ä¾§è¾¹æ  */
    #noteList { list-style: none; max-height: calc(100vh - 200px); overflow-y: auto; margin: 0.5rem 0; }
    .note-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
    .note-item:hover { background: var(--light); }
    .note-item.active { font-weight: 600; background: var(--light); }
    .note-actions { display: flex; gap: 0.3rem; }

    /* ç¼–è¾‘åŒº */
    #editor-header { margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; justify-content: space-between; flex-wrap: wrap; }
    #currentTitle { font-size: 1.6rem; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #previewToggle { padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.9rem; }
    #previewContent { padding: 1.2rem; line-height: 1.7; display: none; font-size: var(--font-size); }
    #previewContent code { background: var(--light); padding: 0.2rem 0.4rem; border-radius: 4px; }
    #previewContent pre { background: var(--light); padding: 0.8rem; border-radius: 6px; overflow-x: auto; }
    #previewContent blockquote { border-left: 3px solid var(--primary); padding-left: 1rem; margin: 0.5rem 0; opacity: 0.8; }
    #previewContent h1, #previewContent h2, #previewContent h3 { margin-top: 1.2rem; margin-bottom: 0.8rem; }
    textarea#noteContent {
      width: 100%; min-height: 300px; resize: vertical;
      padding: 1.2rem; line-height: 1.7; font-size: var(--font-size);
      border-radius: 8px;
    }
    #tagInput { width: 100%; margin-top: 0.5rem; }
    .tag-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.9rem; margin: 0.2rem 0.3rem 0 0; }

    /* é¡¶éƒ¨å·¥å…·æ  */
    #toolbar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;
    }
    select { padding: 0.4rem 0.8rem; border-radius: 6px; border: 1px solid; background: transparent; }
    #fontSizeSlider { width: 80px; margin: 0 0.5rem; }
    @media (max-width: 768px) {
        #toolbar { flex-direction: row; align-items: center; }
        #toolbar > div:first-child { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        #fontSizeSlider, #fontSizeDisplay { display: none; }
    }
  </style>
</head>
<body>

<div id="loader">
  <h2 style="margin-bottom:1rem;font-size:1.5rem;">åŒ£ä¹‹å›å“</h2>
  <div class="spinner"></div>
</div>

<div id="login" style="display:none;max-width:400px;margin:5rem auto;padding:2rem;" class="card">
  <h2 style="text-align:center;margin-bottom:1.5rem;">åŒ£ä¹‹å›å“</h2>
  <input type="text" id="username" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" style="width:100%;margin:0.6rem 0;"/>
  <button onclick="login()" class="btn" style="width:100%;">è¿›å…¥</button>
</div>

<!-- ä¿®å¤ï¼šæ‰‹æœºç«¯ä¾§è¾¹æ é®ç½© -->
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="app">
  <div id="toolbar">
    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
      <button class="btn" onclick="toggleSidebar()">ğŸ“± ç›®å½•</button>
      <button class="btn" onclick="toggleTheme()">ğŸŒ“ æ—¥/å¤œ</button>
      <input type="text" id="searchInput" placeholder="æœç´¢ç¬”è®°..." oninput="filterNotes()" style="flex:1; min-width: 100px;"/>
    </div>
    <div style="display:flex;align-items:center;gap:0.5rem;">
        <button class="btn" onclick="createNewNote()">+ æ–°ç¬”è®°</button>
        <div>ä½ å¥½ï¼Œ<span id="userName"></span></div>
    </div>
  </div>

  <div id="app" class="grid">
    <div id="sidebar" class="card hidden">
      <h2>æˆ‘çš„ç¬”è®°</h2>
      <div style="margin: 0.5rem 0; display:flex; align-items: center; gap: 0.5rem;">
        <label for="fontSizeSlider">å­—å·: </label>
        <input type="range" id="fontSizeSlider" min="12" max="24" value="17" oninput="changeFontSize(this.value)">
        <span id="fontSizeDisplay">17px</span>
      </div>
      <select id="fontSelector" onchange="changeFont()" style="width:100%; margin: 0.5rem 0;">
        <option value="Source Han Serif SC">æ€æºå®‹ä½“</option>
        <option value="LXGW WenKai Screen">éœé¹œæ–‡æ¥·</option>
        <option value="ZCOOL KuaiLe">ç«™é…·å¿«ä¹ä½“</option>
        <option value="Noto Sans SC">Noto æ— è¡¬çº¿</option>
        <option value="Fira Code">Fira Code</option>
      </select>
      <button class="btn" style="width:100%; margin: 0.5rem 0;" onclick="importNotes()">ğŸ“¥ å¯¼å…¥ç¬”è®°</button>
      <ul id="noteList"></ul>
      <div style="margin-top:1rem; display:flex; gap:0.5rem;">
        <button class="btn" style="flex:1;" onclick="exportAllNotes()">å¯¼å‡ºå…¨éƒ¨</button>
      </div>
    </div>

    <div id="editor">
      <div class="card">
        <div id="editor-header">
          <div id="currentTitle">æœªå‘½å</div>
          <button class="btn" id="previewToggle" onclick="togglePreview()">ğŸ‘ï¸ é¢„è§ˆ</button>
          <button class="btn" onclick="renameCurrentNote()">âœï¸ é‡å‘½å</button>
        </div>
        <textarea id="noteContent" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å›å“â€¦"></textarea>
        <div id="previewContent"></div>
        <input type="text" id="tagInput" placeholder="æ·»åŠ æ ‡ç­¾ï¼Œå¦‚ï¼š#æ‰‹å¸ #çµæ„Ÿ" onblur="addTags()"/>
        <div id="tagDisplay"></div>
        <div style="margin-top:1rem; display:flex; gap:0.6rem; flex-wrap:wrap;">
          <button class="btn" onclick="saveCurrentNote()">ğŸ’¾ ä¿å­˜</button>
          <button class="btn" onclick="exportCurrentNote('md')">ğŸ“¥ .md</button>
          <button class="btn" onclick="logout()">ğŸšª é€€å‡º</button>
        </div>
        <p id="status" style="margin-top:0.8rem; font-size:0.9rem; color: #888;"></p>
      </div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'box_resonance_v210';
  let currentUser = null;
  let currentNoteId = null;
  let currentTheme = 'light';
  let currentSeason = getSeason();
  let currentFont = 'Source Han Serif SC';
  let currentFontSize = 17; // é»˜è®¤å­—å·
  let isPreviewMode = false;
  let previewTimeout = null; // ç”¨äºé˜²æŠ–
  let isSidebarVisible = false; // ä¾§è¾¹æ çŠ¶æ€

  // === è½»é‡çº§ Markdown è§£æå™¨ï¼ˆçº¯ JSï¼Œæ— éœ€å¤–éƒ¨åº“ï¼‰===
  function simpleMarkdownParse(text) {
    if (!text) return '';
    let html = text
      // è½¬ä¹‰ HTML æ ‡ç­¾
      .replace(/&/g, '&amp;')
      .replace(/</g, '<')
      .replace(/>/g, '>')

      // æ ‡é¢˜
      .replace(/^###### (.*$)/gim, '<h6>$1</h6>')
      .replace(/^##### (.*$)/gim, '<h5>$1</h5>')
      .replace(/^#### (.*$)/gim, '<h4>$1</h4>')
      .replace(/^### (.*$)/gim, '<h3>$1</h3>')
      .replace(/^## (.*$)/gim, '<h2>$1</h2>')
      .replace(/^# (.*$)/gim, '<h1>$1</h1>')

      // æ¢è¡Œ
      .replace(/\n/g, '<br>')

      // ç²—ä½“
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/__(.*?)__/g, '<strong>$1</strong>')

      // æ–œä½“
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/_(.*?)_/g, '<em>$1</em>')

      // ä»£ç å—ï¼ˆè¡Œå†…ï¼‰
      .replace(/`(.*?)`/g, '<code>$1</code>')

      // æ— åºåˆ—è¡¨
      .replace(/^- (.*$)/gim, '<li>$1</li>')
      .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')

      // æœ‰åºåˆ—è¡¨
      .replace(/^(\d+)\. (.*$)/gim, '<li value="$1">$2</li>')
      .replace(/(<li value=".*">.*<\/li>)/gs, '<ol>$1</ol>')

      // å¼•ç”¨
      .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');

    // æ¸…ç†å¤šä½™çš„æ¢è¡Œå’Œæ ‡ç­¾
    html = html.replace(/<br><\/h[1-6]>/g, '</h$1>');
    html = html.replace(/<br><\/blockquote>/g, '</blockquote>');
    html = html.replace(/<br><\/ul>/g, '</ul>');
    html = html.replace(/<br><\/ol>/g, '</ol>');
    html = html.replace(/<br><\/li>/g, '</li>');
    html = html.replace(/<br><\/code>/g, '</code>');
    html = html.replace(/<br>/g, '<br />'); // ç¡®ä¿æ¢è¡Œæ˜¯è‡ªé—­åˆæ ‡ç­¾
    return html;
  }

  const themes = {
    light: { bg: '#f9f7f2', text: '#333', border: '#ddd', card: '#fff', primary: '#8a7f70', light: '#e8e0d0' },
    dark: { bg: '#1e1e20', text: '#e6e1d9', border: '#444', card: '#2a2a2d', primary: '#b8a99a', light: '#3a3a3d' }
  };

  const fonts = {
    'Source Han Serif SC': "'Source Han Serif SC', serif",
    'LXGW WenKai Screen': "'LXGW WenKai Screen', sans-serif",
    'ZCOOL KuaiLe': "'ZCOOL KuaiLe', cursive",
    'Noto Sans SC': "'Noto Sans SC', sans-serif",
    'Fira Code': "'Fira Code', monospace"
  };

  // ä¿®å¤ï¼šå°† applyTheme åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œé¿å…åˆå§‹åŒ–æ—¶æ ·å¼å†²çª
  function applyTheme() {
    const t = themes[currentTheme];
    const root = document.documentElement;

    // ç¬¬ä¸€éƒ¨åˆ†ï¼šå…ˆè®¾ç½®åŸºç¡€å˜é‡
    root.style.setProperty('--bg', t.bg);
    root.style.setProperty('--text', t.text);
    root.style.setProperty('--border', t.border);
    root.style.setProperty('--card', t.card);
    root.style.setProperty('--primary', t.primary);
    root.style.setProperty('--light', t.light);
    root.style.setProperty('--font-family', fonts[currentFont]);

    // ç¬¬äºŒéƒ¨åˆ†ï¼šå»¶è¿Ÿè®¾ç½®å­—å·ï¼Œé¿å…åˆå§‹åŒ–å†²çª
    setTimeout(() => {
      root.style.setProperty('--font-size', currentFontSize + 'px');
      // ä¸»é¢˜æ ·å¼
      document.getElementById('theme-style').textContent = `
        body { background: ${t.bg}; color: ${t.text}; }
        .card { background: ${t.card}; border: 1px solid ${t.border}; }
        input, textarea { background: ${t.card}; color: ${t.text}; border-color: ${t.border}; }
        .btn { background: ${t.light}; color: ${t.primary}; }
        .btn:hover { opacity: 0.9; }
        .note-item.active { background: ${t.light}; color: ${t.primary}; }
        .tag-badge { background: ${t.light}; color: ${t.text}; }
        .spinner { border-color: ${t.border}; }
        #loader { background: ${t.bg}; color: ${t.text}; }
        #login { background: ${t.card}; color: ${t.text}; border: 1px solid ${t.border}; }
      `;
      // å­£èŠ‚æ ·å¼
      let seasonCSS = '';
      if (currentSeason === 'spring') {
        const bg = currentTheme === 'light' ? t.bg : '#2a2a2c';
        seasonCSS = `
          body { background: linear-gradient(135deg, ${bg} 0%, ${currentTheme === 'light' ? '#f0f7f4' : '#3a3a3c'} 100%); }
          body::before {
            content: "ğŸŒ¸"; position: fixed; opacity: 0.15; font-size: 20px;
            animation: fall 12s infinite linear; animation-delay: 0s;
            top: -20px; left: 10%; z-index: -1;
          }
          body::after {
            content: "ğŸŒ¸"; position: fixed; opacity: 0.15; font-size: 18px;
            animation: fall 15s infinite linear; animation-delay: 3s;
            top: -18px; left: 60%; z-index: -1;
          }
          @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); }
          }
        `;
      } else if (currentSeason === 'summer') {
        const bg = currentTheme === 'light' ? '#fffef7' : '#2a2a2a';
        seasonCSS = `
          body { background: linear-gradient(135deg, ${bg} 0%, ${currentTheme === 'light' ? '#fefdf6' : '#3a3a3a'} 100%); }
          body::before {
            content: "âœ¨"; position: fixed; opacity: 0.1; font-size: 12px;
            animation: float 8s infinite ease-in-out; animation-delay: 0s;
            top: 20%; left: 20%; z-index: -1;
          }
          body::after {
            content: "âœ¨"; position: fixed; opacity: 0.1; font-size: 10px;
            animation: float 10s infinite ease-in-out; animation-delay: 2s;
            top: 60%; left: 70%; z-index: -1;
          }
          @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-10px) translateX(5px); }
            50% { transform: translateY(0) translateX(10px); }
            75% { transform: translateY(5px) translateX(-5px); }
          }
        `;
      } else if (currentSeason === 'autumn') {
        const bg = currentTheme === 'light' ? '#fdf8f0' : '#2a2a28';
        seasonCSS = `
          body { background: linear-gradient(135deg, ${bg} 0%, ${currentTheme === 'light' ? '#f9f4ed' : '#3a3a38'} 100%); }
          body::before {
            content: "ğŸ‚"; position: fixed; opacity: 0.15; font-size: 24px;
            animation: fall 15s infinite linear; animation-delay: 0s;
            top: -30px; left: 20%; z-index: -1;
          }
          body::after {
            content: "ğŸ"; position: fixed; opacity: 0.12; font-size: 22px;
            animation: fall 18s infinite linear; animation-delay: 5s;
            top: -28px; left: 70%; z-index: -1;
          }
          @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); }
          }
        `;
      } else if (currentSeason === 'winter') {
        const bg = currentTheme === 'light' ? '#f8f9fa' : '#282a2a';
        seasonCSS = `
          body { background: linear-gradient(135deg, ${bg} 0%, ${currentTheme === 'light' ? '#eef2f7' : '#383a3a'} 100%); }
          body::before {
            content: "â„ï¸"; position: fixed; opacity: 0.1; font-size: 16px;
            animation: snow 10s infinite linear; animation-delay: 0s;
            top: -20px; left: 40%; z-index: -1;
          }
          body::after {
            content: "â…"; position: fixed; opacity: 0.08; font-size: 14px;
            animation: snow 12s infinite linear; animation-delay: 4s;
            top: -18px; left: 80%; z-index: -1;
          }
          @keyframes snow {
            to { transform: translateY(100vh) rotate(180deg); }
          }
        `;
      }
      document.getElementById('season-style').textContent = seasonCSS;

      // ä¿å­˜çŠ¶æ€
      localStorage.setItem('box_resonance_theme', currentTheme);
      localStorage.setItem('box_resonance_season', currentSeason);
      localStorage.setItem('box_resonance_font', currentFont);
      localStorage.setItem('box_resonance_font_size', currentFontSize);
      document.getElementById('season-toggle').textContent = `ğŸƒ ${['æ˜¥','å¤','ç§‹','å†¬']['spring,summer,autumn,winter'.split(',').indexOf(currentSeason)]}`;
      document.getElementById('fontSelector').value = currentFont;
    }, 0); // 0ms å»¶è¿Ÿï¼Œç¡®ä¿åœ¨ä¸»è„šæœ¬æ‰§è¡Œå®Œåè¿è¡Œ
  }

  function getSeason() {
    const month = new Date().getMonth() + 1;
    if (month >= 3 && month <= 5) return 'spring';
    if (month >= 6 && month <= 8) return 'summer';
    if (month >= 9 && month <= 11) return 'autumn';
    return 'winter';
  }

  function cycleSeason() {
    const list = ['spring', 'summer', 'autumn', 'winter'];
    const idx = list.indexOf(currentSeason);
    currentSeason = list[(idx + 1) % 4];
    applyTheme();
  }

  function toggleTheme() {
    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
    applyTheme();
  }

  function changeFont() {
    currentFont = document.getElementById('fontSelector').value;
    applyTheme();
  }

  // ä¿®å¤ï¼šå­—å·è°ƒèŠ‚å‡½æ•°
  function changeFontSize(size) {
    currentFontSize = parseInt(size); // âŒ é”™è¯¯ï¼šè¿™é‡Œåº”è¯¥æ˜¯ currentFontSize
    document.getElementById('fontSizeDisplay').textContent = size + 'px';
    applyTheme(); // è§¦å‘ä¸»é¢˜æ›´æ–°
  }

  // ä¿®å¤ï¼šåˆ‡æ¢ä¾§è¾¹æ å‡½æ•°
  function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      isSidebarVisible = !isSidebarVisible;
      if (isSidebarVisible) {
          sidebar.classList.add('shown');
          sidebar.classList.remove('hidden');
          overlay.style.display = 'block';
      } else {
          sidebar.classList.remove('shown');
          sidebar.classList.add('hidden');
          overlay.style.display = 'none';
      }
      localStorage.setItem('box_resonance_sidebar_visible', isSidebarVisible);
  }

  // === æ³¢çº¹æ•ˆæœ ===
  function addRippleEffect(e) {
    const button = e.currentTarget;
    const ripple = document.createElement('span');
    ripple.className = 'ripple';
    const rect = button.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = e.clientX - rect.left - size / 2;
    const y = e.clientY - rect.top - size / 2;
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    button.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
  }

  document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('click', addRippleEffect);
  });

  // === ç™»å½• ===
  function login() {
    const name = document.getElementById('username').value?.trim();
    if (!name) return alert('è¯·è¾“å…¥åå­—');
    currentUser = name;
    localStorage.setItem('box_resonance_user', name);
    document.getElementById('userName').textContent = name;
    showApp();
  }

  function checkLogin() {
    const saved = localStorage.getItem('box_resonance_user');
    if (saved) {
      currentUser = saved;
      // æ¢å¤å­—å·
      const savedSize = localStorage.getItem('box_resonance_font_size');
      if (savedSize) currentFontSize = parseInt(savedSize);
      document.getElementById('fontSizeSlider').value = currentFontSize;
      document.getElementById('fontSizeDisplay').textContent = currentFontSize + 'px';

      // æ¢å¤ä¾§è¾¹æ çŠ¶æ€
      const savedSidebar = localStorage.getItem('box_resonance_sidebar_visible');
      isSidebarVisible = savedSidebar === 'true';
      if (!isSidebarVisible) {
          document.getElementById('sidebar').classList.add('hidden');
          document.getElementById('app').style.gridTemplateColumns = '0fr 1fr';
      }

      document.getElementById('userName').textContent = saved;
      showApp();
    } else {
      document.getElementById('login').style.display = 'block';
    }
  }

  function showApp() {
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadNotes();
  }

  // === ç¬”è®°æ•°æ®ç®¡ç† ===
  function getNotes() {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    return data[currentUser] || { notes: {}, order: [] };
  }

  function saveNotes(notesData) {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    data[currentUser] = notesData;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  // === ç¬”è®°æ“ä½œ ===
  function createNewNote() {
    const title = prompt('è¯·è¾“å…¥ç¬”è®°æ ‡é¢˜ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨æ—¥æœŸï¼‰ï¼š', getTodayDate());
    const finalTitle = title !== null ? (title.trim() || getTodayDate()) : getTodayDate();
    const id = Date.now().toString();
    const notesData = getNotes();
    notesData.notes[id] = {
      title: finalTitle,
      content: '',
      tags: [],
      createdAt: new Date().toISOString()
    };
    notesData.order.unshift(id);
    saveNotes(notesData);
    loadNotes();
    openNote(id);
  }

  function deleteNote(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) return;
    const notesData = getNotes();
    delete notesData.notes[id];
    notesData.order = notesData.order.filter(noteId => noteId !== id);
    saveNotes(notesData);
    if (currentNoteId === id) {
        currentNoteId = notesData.order[0] || null;
        if (currentNoteId) openNote(currentNoteId);
        else {
            document.getElementById('currentTitle').textContent = 'æœªå‘½å';
            document.getElementById('noteContent').value = '';
            document.getElementById('tagDisplay').innerHTML = '';
        }
    }
    loadNotes();
    showStatus('ğŸ—‘ï¸ ç¬”è®°å·²åˆ é™¤');
  }

  function renameCurrentNote() {
    if (!currentNoteId) return;
    const notesData = getNotes();
    const note = notesData.notes[currentNoteId];
    const newTitle = prompt('é‡å‘½åç¬”è®°ï¼š', note.title);
    if (newTitle !== null) {
      note.title = newTitle.trim() || 'æœªå‘½å';
      saveNotes(notesData);
      loadNotes();
      openNote(currentNoteId);
    }
  }

  function openNote(id) {
    const notesData = getNotes();
    const note = notesData.notes[id];
    if (!note) return;

    currentNoteId = id;
    document.getElementById('currentTitle').textContent = note.title || 'æœªå‘½å';
    document.getElementById('noteContent').value = note.content || '';
    renderTags(note.tags || []);
    // æ›´æ–°é¢„è§ˆ
    if (isPreviewMode) {
        updatePreview(note.content);
    }
    document.querySelectorAll('.note-item').forEach(el => el.classList.remove('active'));
    const activeEl = [...document.querySelectorAll('.note-item')].find(el => el.dataset.id === id);
    if (activeEl) activeEl.classList.add('active');

    // ä¿®å¤ï¼šåœ¨æ‰‹æœºç«¯æ‰“å¼€ç¬”è®°åè‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ 
    if (window.innerWidth <= 768 && isSidebarVisible) {
        toggleSidebar();
    }
  }

  function saveCurrentNote() {
    const content = document.getElementById('noteContent').value;
    if (!currentNoteId) {
        if (content.trim() === '') return;
        const title = getTodayDate();
        const id = Date.now().toString();
        const notesData = getNotes();
        notesData.notes[id] = {
          title: title,
          content: content,
          tags: [],
          createdAt: new Date().toISOString()
        };
        notesData.order.unshift(id);
        saveNotes(notesData);
        loadNotes();
        openNote(id);
        showStatus('âœ… å·²ä¿å­˜åˆ°æ–°ç¬”è®°');
        return;
    }

    const notesData = getNotes();
    const note = notesData.notes[currentNoteId];
    note.content = content;
    note.updatedAt = new Date().toISOString();
    saveNotes(notesData);
    if (isPreviewMode) {
        updatePreview(note.content);
    }
    const now = new Date();
    const timeStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    showStatus(`âœ… å·²ä¿å­˜ (${timeStr})`);
  }

  // === Markdown é¢„è§ˆ ===
  function updatePreview(content) {
    if (!isPreviewMode) return;
    const html = simpleMarkdownParse(content || '');
    document.getElementById('previewContent').innerHTML = html;
  }

  function togglePreview() {
    isPreviewMode = !isPreviewMode;
    const contentEl = document.getElementById('noteContent');
    const previewEl = document.getElementById('previewContent');
    const toggleBtn = document.getElementById('previewToggle');
    if (isPreviewMode) {
        const content = contentEl.value;
        updatePreview(content);
        contentEl.style.display = 'none';
        previewEl.style.display = 'block';
        toggleBtn.textContent = 'ğŸ“ ç¼–è¾‘';
    } else {
        contentEl.style.display = 'block';
        previewEl.style.display = 'none';
        toggleBtn.textContent = 'ğŸ‘ï¸ é¢„è§ˆ';
    }
  }

  // === æ ‡ç­¾ç³»ç»Ÿ ===
  function addTags() {
    if (!currentNoteId) return;
    const input = document.getElementById('tagInput');
    const tags = input.value.split(/\s+/).filter(t => t.trim().startsWith('#')).map(t => t.trim());
    if (tags.length === 0) return;
    const notesData = getNotes();
    notesData.notes[currentNoteId].tags = [...new Set(tags)];
    saveNotes(notesData);
    renderTags(tags);
    input.value = '';
    loadNotes();
  }

  function renderTags(tags) {
    const el = document.getElementById('tagDisplay');
    el.innerHTML = tags.map(tag => `<span class="tag-badge">${tag}</span>`).join('');
  }

  // === æœç´¢ä¸ç­›é€‰ ===
  function filterNotes() {
    loadNotes();
  }

  // === å¯¼å‡º ===
  function exportCurrentNote(format) {
    const content = document.getElementById('noteContent').value;
    const title = document.getElementById('currentTitle').textContent;
    let blob, filename;
    if (format === 'md') {
      blob = new Blob([content], { type: 'text/markdown' });
      filename = (title || 'æœªå‘½å') + '.md';
    } else {
      blob = new Blob([content], { type: 'text/plain' });
      filename = (title || 'æœªå‘½å') + '.txt';
    }
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportAllNotes() {
    const notesData = getNotes();
    let text = `# åŒ£ä¹‹å›å“ - å…¨éƒ¨ç¬”è®°å¯¼å‡º\n\n`;
    notesData.order.forEach(id => {
      const note = notesData.notes[id];
      text += `## ${note.title || 'æœªå‘½å'}\n`;
      if (note.tags?.length) text += `æ ‡ç­¾: ${note.tags.join(' ')}\n\n`;
      text += `${note.content}\n\n---\n\n`;
    });
    const blob = new Blob([text], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'åŒ£ä¹‹å›å“_å…¨éƒ¨ç¬”è®°.md';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // === å¯¼å…¥åŠŸèƒ½ ===
  function importNotes() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.md,.txt';
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const title = prompt('ä¸ºå¯¼å…¥çš„ç¬”è®°è®¾ç½®æ ‡é¢˜ï¼š', file.name.replace(/\.(md|txt)$/, ''));
            if (!title) return;
            const id = Date.now().toString();
            const notesData = getNotes();
            notesData.notes[id] = {
              title: title,
              content: content,
              tags: [],
              createdAt: new Date().toISOString()
            };
            notesData.order.unshift(id);
            saveNotes(notesData);
            loadNotes();
            openNote(id);
            showStatus(`âœ… å·²å¯¼å…¥ç¬”è®°ï¼š${title}`);
        };
        reader.readAsText(file);
    };
    input.click();
  }

  // === å·¥å…·å‡½æ•° ===
  function getTodayDate() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function loadNotes() {
    const notesData = getNotes();
    const listEl = document.getElementById('noteList');
    const search = document.getElementById('searchInput').value.toLowerCase();

    const allTags = new Set();
    Object.values(notesData.notes).forEach(note => {
      (note.tags || []).forEach(tag => allTags.add(tag));
    });

    const tagFilterEl = document.getElementById('tagFilter');
    tagFilterEl.innerHTML = '<div style="margin-bottom:0.5rem;"><strong>æ ‡ç­¾ç­›é€‰ï¼š</strong></div>';
    allTags.forEach(tag => {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.style.fontSize = '0.8rem';
      btn.style.padding = '0.2rem 0.6rem';
      btn.textContent = tag;
      btn.onclick = (e) => {
        e.stopPropagation();
        document.getElementById('searchInput').value = tag;
        filterNotes();
      };
      tagFilterEl.appendChild(btn);
    });

    listEl.innerHTML = '';
    notesData.order.forEach(id => {
      const note = notesData.notes[id];
      if (!note) return;
      const match = !search ||
        note.title.toLowerCase().includes(search) ||
        note.content.toLowerCase().includes(search) ||
        (note.tags || []).some(t => t.includes(search));
      if (!match) return;

      const li = document.createElement('li');
      li.className = 'note-item ' + (id === currentNoteId ? 'active' : '');
      li.dataset.id = id;

      const titleSpan = document.createElement('span');
      titleSpan.textContent = note.title || 'æœªå‘½å';
      titleSpan.onclick = () => openNote(id);

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'note-actions';
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'ğŸ—‘ï¸';
      deleteBtn.className = 'btn';
      deleteBtn.style.padding = '0.2rem 0.4rem';
      deleteBtn.style.fontSize = '0.8rem';
      deleteBtn.onclick = (e) => { e.stopPropagation(); deleteNote(id); };
      actionsDiv.appendChild(deleteBtn);

      li.appendChild(titleSpan);
      li.appendChild(actionsDiv);
      listEl.appendChild(li);
    });

    if (!currentNoteId && notesData.order.length > 0) {
      openNote(notesData.order[0]);
    }
  }

  function logout() {
    currentUser = null;
    currentNoteId = null;
    isPreviewMode = false;
    document.getElementById('app').style.display = 'none';
    document.getElementById('login').style.display = 'block';
    document.getElementById('username').value = '';
  }

  function showStatus(msg) {
    const el = document.getElementById('status');
    el.textContent = msg;
    setTimeout(() => el.textContent = '', 2000);
  }

  // è‡ªåŠ¨ä¿å­˜ + å®æ—¶é¢„è§ˆ
  document.addEventListener('DOMContentLoaded', () => {
    const editor = document.getElementById('noteContent');
    if (editor) {
      editor.addEventListener('input', () => {
        if (currentNoteId || editor.value.trim() !== '') {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                saveCurrentNote();
                if (isPreviewMode) {
                    updatePreview(editor.value);
                }
            }, 300);
        }
      });
    }
  });

  // === åˆå§‹åŒ– ===
  window.onload = () => {
    currentTheme = localStorage.getItem('box_resonance_theme') || 'light';
    currentSeason = localStorage.getItem('box_resonance_season') || getSeason();
    currentFont = localStorage.getItem('box_resonance_font') || 'Source Han Serif SC';
    const savedSize = localStorage.getItem('box_resonance_font_size');
    if (savedSize) currentFontSize = parseInt(savedSize);
    document.getElementById('fontSizeSlider').value = currentFontSize;
    document.getElementById('fontSizeDisplay').textContent = currentFontSize + 'px';
    applyTheme(); // ä¿®å¤ï¼šç°åœ¨è¿™ä¸ªå‡½æ•°ä¼šå®‰å…¨åœ°æ‰§è¡Œ

    setTimeout(() => {
      document.getElementById('loader').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loader').style.display = 'none';
        checkLogin();
      }, 400);
    }, 800);
  };
</script>

</body>
</html>
