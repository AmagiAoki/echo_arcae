<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åŒ£ä¹‹å›å“ â€” ç»ˆæä¿®å¤ v2.92</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Han+Serif+SC:wght@400;600&family=LXGW+WenKai+Screen&family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;600&family=Fira+Code&display=swap" rel="stylesheet">
  <style id="dynamic-font"></style>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f9f7f2;
      --text: #333;
      --card: #fff;
      --border: #ddd;
      --primary: #8a7f70;
      --light: #e8e0d0;
      --font-family: 'Source Han Serif SC', serif;
      --font-size: 16px;
      --radius: 16px;
      --slide-transition: transform 0.32s cubic-bezier(0.22, 0.61, 0.36, 1);
    }
    body {
      font-family: var(--font-family);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.7;
      overflow-x: hidden;
      position: relative;
    }

    /* ========== æ°´æ³¢çº¹ ========== */
    .ripple-btn {
      padding: 10px 14px;
      border-radius: var(--radius);
      border: none;
      background: var(--light);
      color: var(--primary);
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
      min-width: 70px;
      text-align: center;
      font-size: 0.92rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      overflow: hidden;
      position: relative;
    }
    .ripple-btn:hover {
      background: color-mix(in srgb, var(--light) 85%, var(--primary));
    }
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      transform: scale(0);
      animation: ripple 0.6s linear;
      pointer-events: none;
    }
    @keyframes ripple {
      to { transform: scale(4); opacity: 0; }
    }

    /* ========== é«˜ç«¯åŠ è½½åŠ¨ç”» ========== */
    #loader {
      position: fixed; left: 0; top: 0; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 24px;
      background: linear-gradient(135deg, #f0f4f8, #e6e9f0);
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.6s ease;
    }
    .loader-logo {
      font-size: 2.8rem;
      font-weight: 600;
      opacity: 0;
      transform: translateY(20px) scale(0.9);
      animation: fadeInUp 1.2s forwards 0.3s;
      background: linear-gradient(120deg, #8a7f70, #5a5048);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .loader-dots {
      display: flex;
      gap: 8px;
    }
    .loader-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      opacity: 0;
      animation: dotBounce 1.4s infinite ease-in-out;
    }
    .loader-dot:nth-child(2) { animation-delay: 0.14s; }
    .loader-dot:nth-child(3) { animation-delay: 0.28s; }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes dotBounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
      40% { transform: translateY(-16px); opacity: 1; }
    }

    .modal-backdrop {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.3); z-index: 998;
      opacity: 0; visibility: hidden;
      transition: opacity 0.28s, visibility 0.28s;
    }
    .modal-backdrop.active {
      opacity: 1; visibility: visible;
    }

    #top-bar {
      position: sticky; top: 0; z-index: 997;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    #note-title {
      font-size: 1.3rem;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,0.6);
      cursor: pointer;
    }

    /* ========== ä¾§è¾¹æ æ»‘åŠ¨ ========== */
    #sidebar, #detailPanel {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      height: 100vh;
      overflow: auto;
      position: fixed;
      top: 0;
      z-index: 1000;
      transition: var(--slide-transition);
      width: 92vw;
      max-width: 340px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    #sidebar { left: 0; transform: translateX(-100%); }
    #sidebar.shown { transform: translateX(0); }
    #detailPanel { right: 0; transform: translateX(100%); }
    #detailPanel.shown { transform: translateX(0); }

    #app-container {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      padding-top: 80px;
    }

    #editor {
      min-height: 60vh;
    }

    #writing-area {
      position: relative;
    }

    #noteContent, #previewContent {
      width: 100%;
      min-height: 360px;
      padding: 20px;
      font-size: var(--font-size);
      font-family: var(--font-family);
      line-height: 1.8;
      white-space: pre-wrap;
      word-break: break-word;
      caret-color: var(--primary);
    }

    #noteContent {
      outline: none;
      background: transparent;
      border: none;
    }

    #previewContent {
      display: none;
      overflow: auto;
      background: transparent;
    }

    #sidebar-footer {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      padding: 12px;
      z-index: 1;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    }

    input[type="text"] {
      padding: 8px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-family: inherit;
    }

    .muted { color: color-mix(in srgb, var(--text) 60%, transparent); font-size: 0.9rem; }

    /* ========== æ ‡ç­¾ ========== */
    .tag-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 14px;
      margin: 4px 6px 4px 0;
      background: transparent;
      color: var(--text);
      border: 1.5px solid var(--border);
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.88rem;
      transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-weight: 500;
    }
    .tag-btn:hover {
      border-color: var(--primary);
      background: color-mix(in srgb, var(--light) 40%, transparent);
    }
    .tag-btn.active {
      background: var(--primary);
      color: white !important;
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(138, 127, 112, 0.25);
      transform: translateY(-1px);
    }

    /* ========== ç¬”è®°å¡ç‰‡ ========== */
    .note-card {
      position: relative;
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 14px;
      cursor: pointer;
      background: var(--card);
      border: 1px solid var(--border);
      transition: all 0.3s cubic-bezier(0.22, 0.61, 0.36, 1);
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
      opacity: 0;
      transform: translateY(10px);
      animation: cardSlideIn 0.4s forwards;
    }
    @keyframes cardSlideIn {
      to { opacity: 1; transform: translateY(0); }
    }
    .note-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      border-color: color-mix(in srgb, var(--border) 70%, var(--primary));
    }
    .note-card.active {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(138, 127, 112, 0.15);
    }

    /* ========== é¢„è§ˆæ¨¡å¼ ========== */
    #previewContent h1, #previewContent h2, #previewContent h3, #previewContent h4, #previewContent h5, #previewContent h6 {
      margin: 1.2em 0 0.5em;
      font-weight: 600;
      line-height: 1.3;
    }
    #previewContent h1 { font-size: 2rem; }
    #previewContent h2 { font-size: 1.5rem; }
    #previewContent h3 { font-size: 1.25rem; }
    #previewContent h4 { font-size: 1.1rem; }
    #previewContent h5 { font-size: 1rem; }
    #previewContent h6 { font-size: 0.9rem; }
    #previewContent strong { font-weight: bold; }
    #previewContent em { font-style: italic; }
    #previewContent code {
      font-family: monospace;
      background: var(--light);
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    #previewContent del { text-decoration: line-through; }
    #previewContent hr {
      border: 0;
      border-top: 1px solid var(--border);
      margin: 1.5em 0;
    }
    #previewContent p { margin: 0.5em 0; }
    #previewContent ul, #previewContent ol {
      margin: 0.5em 0 0.5em 1.5em;
      padding: 0;
    }
    #previewContent li { margin: 0.2em 0; }

    /* ========== ä¿å­˜æç¤º ========== */
    .save-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: #fff;
      padding: 12px 20px;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .save-toast.show {
      opacity: 1;
      visibility: visible;
    }

    /* ========== âœ¨ æ¶²æ€ç»ç’ƒçš®è‚¤ï¼ˆiOS æ§åˆ¶ä¸­å¿ƒé£æ ¼ï¼‰ ========== */
    body[skin="glass"] {
      --bg: linear-gradient(135deg, #f8fbff, #f0f4fa);
      --text: #2c3e50;
      --card: rgba(255, 255, 255, 0.7);
      --border: rgba(200, 210, 230, 0.5);
      --primary: #5a8dde;
      --light: rgba(230, 240, 255, 0.6);
    }
    body[skin="glass"] #top-bar,
    body[skin="glass"] #sidebar,
    body[skin="glass"] #detailPanel,
    body[sky="glass"] #sidebar-footer {
      background: rgba(255, 255, 255, 0.65);
      border-color: rgba(200, 210, 230, 0.5);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      box-shadow: 0 8px 32px rgba(90, 141, 222, 0.08);
    }
    body[skin="glass"] .note-card {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(200, 210, 230, 0.5);
    }
    body[skin="glass"] .tag-btn {
      border-color: rgba(200, 210, 230, 0.6);
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(90, 141, 222, 0.05);
    }
    body[skin="glass"] .tag-btn.active {
      background: var(--primary);
      color: white !important;
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(90, 141, 222, 0.22);
    }
    body[skin="glass"] .ripple-btn {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(200, 210, 230, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(90, 141, 222, 0.05);
      color: var(--text);
    }
    body[skin="glass"] .ripple-btn:hover {
      background: rgba(255, 255, 255, 0.85);
      border-color: var(--primary);
    }

    /* ========== å¤œ Â· å¢¨è‰² ========== */
    body[skin="dark"] {
      --bg: #1e1e20;
      --text: #e6e1d9;
      --card: #2a2a2d;
      --border: #444;
      --primary: #b8a99a;
      --light: #3a3a3f;
    }
    body[skin="dark"] #top-bar,
    body[skin="dark"] #sidebar,
    body[skin="dark"] #detailPanel,
    body[skin="dark"] #sidebar-footer {
      background: rgba(42, 42, 45, 0.92);
      border-color: #444;
      color: #e6e1d9;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    body[skin="dark"] input[type="text"] {
      background: #2a2a2d;
      color: #e6e1d9;
      border-color: #555;
    }
    body[skin="dark"] .muted {
      color: #aaa;
    }
    body[skin="dark"] #noteContent,
    body[skin="dark"] #previewContent {
      color: #e6e1d9;
    }
    body[skin="dark"] .ripple {
      background: rgba(0, 0, 0, 0.4);
    }
    body[skin="dark"] #loader {
      background: #1e1e20;
    }
    body[skin="dark"] .loader-logo,
    body[skin="dark"] .loader-dot {
      background: linear-gradient(120deg, #b8a99a, #9a8b7a);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* ========== è¯¦æƒ…é¢æ¿ ========== */
    #detailPanel .detail-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    #detailPanel .detail-section h4 {
      margin: 0 0 12px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }
    #detailPanel .detail-row {
      margin: 8px 0;
      display: flex;
      align-items: flex-start;
    }
    #detailPanel .detail-label {
      font-weight: 600;
      min-width: 80px;
      color: var(--text);
    }
    #detailPanel .detail-value {
      flex: 1;
      word-break: break-all;
      color: var(--text);
    }

    @media (max-width: 980px) {
      #top-bar { padding: 10px 16px; }
      .ripple-btn { min-width: 60px; padding: 8px 12px; font-size: 0.88rem; }
      #note-title { font-size: 1.2rem; }
    }
  </style>
</head>
<body>
<div id="loader" aria-hidden="false">
  <div class="loader-logo">åŒ£ä¹‹å›å“</div>
  <div class="loader-dots">
    <div class="loader-dot"></div>
    <div class="loader-dot"></div>
    <div class="loader-dot"></div>
  </div>
</div>

<div class="modal-backdrop" id="sidebarBackdrop"></div>
<div class="modal-backdrop" id="detailBackdrop"></div>
<div class="modal-backdrop" id="skinBackdrop"></div>
<div class="modal-backdrop" id="fontBackdrop"></div>

<div id="skinModal" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.95);background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;z-index:2000;opacity:0;visibility:hidden;transition:all 0.3s;max-width:90vw;width:500px;box-shadow:0 20px 50px rgba(0,0,0,0.15);">
  <h3 style="margin-bottom:20px;text-align:center">ğŸ¨ çš®è‚¤</h3>
  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;">
    <div class="skin-opt ripple-btn" data-skin="default" style="min-width:auto;padding:16px;"><div style="height:60px;border-radius:10px;background:#f9f7f2;color:#333;display:flex;align-items:center;justify-content:center;font-weight:bold;">ç»å…¸ Â· çº¸ç¬º</div></div>
    <div class="skin-opt ripple-btn" data-skin="spring" style="min-width:auto;padding:16px;"><div style="height:60px;border-radius:10px;background:#f8f0e5;color:#5a4a42;display:flex;align-items:center;justify-content:center;font-weight:bold;">æ˜¥ Â· æ¨±ç²‰</div></div>
    <div class="skin-opt ripple-btn" data-skin="summer" style="min-width:auto;padding:16px;"><div style="height:60px;border-radius:10px;background:#eef7f0;color:#2c5f2d;display:flex;align-items:center;justify-content:center;font-weight:bold;">å¤ Â· è·ç»¿</div></div>
    <div class="skin-opt ripple-btn" data-skin="autumn" style="min-width:auto;padding:16px;"><div style="height:60px;border-radius:10px;background:#fef2e9;color:#8b4513;display:flex;align-items:center;justify-content:center;font-weight:bold;">ç§‹ Â· æ«æ©™</div></div>
    <div class="skin-opt ripple-btn" data-skin="winter" style="min-width:auto;padding:16px;"><div style="height:60px;border-radius:10px;background:#f0f4f8;color:#2c3e50;display:flex;align-items:center;justify-content:center;font-weight:bold;">å†¬ Â· é›ªè“</div></div>
    <div class="skin-opt ripple-btn" data-skin="dark" style="min-width:auto;padding:16px;"><div style="height:60px;border-radius:10px;background:#1e1e20;color:#e6e1d9;display:flex;align-items:center;justify-content:center;font-weight:bold;">å¤œ Â· å¢¨è‰²</div></div>
    <div class="skin-opt ripple-btn" data-skin="glass" style="min-width:auto;padding:16px;"><div style="height:60px;border-radius:10px;background:linear-gradient(135deg, #f8fbff, #f0f4fa);color:#2c3e50;display:flex;align-items:center;justify-content:center;font-weight:bold;box-shadow:0 4px 12px rgba(90,141,222,0.2);">âœ¨ æ¶²æ€ç»ç’ƒ</div></div>
  </div>
</div>

<div id="fontModal" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.95);background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;z-index:2000;opacity:0;visibility:hidden;transition:all 0.3s;max-width:90vw;width:500px;box-shadow:0 20px 50px rgba(0,0,0,0.15);">
  <h3 style="margin-bottom:20px;text-align:center">âœ’ï¸ å­—ä½“</h3>
  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;">
    <div class="font-opt ripple-btn" data-font="'Source Han Serif SC', serif" style="min-width:auto;padding:16px;"><div style="height:60px;background:var(--card);color:var(--text);display:flex;align-items:center;justify-content:center;font-family:'Source Han Serif SC';">æ€æºå®‹ä½“</div></div>
    <div class="font-opt ripple-btn" data-font="'LXGW WenKai Screen', sans-serif" style="min-width:auto;padding:16px;"><div style="height:60px;background:var(--card);color:var(--text);display:flex;align-items:center;justify-content:center;font-family:'LXGW WenKai Screen';">éœé¹œæ–‡æ¥·</div></div>
    <div class="font-opt ripple-btn" data-font="'ZCOOL KuaiLe', cursive" style="min-width:auto;padding:16px;"><div style="height:60px;background:var(--card);color:var(--text);display:flex;align-items:center;justify-content:center;font-family:'ZCOOL KuaiLe';">å¿«ä¹ä½“</div></div>
    <div class="font-opt ripple-btn" data-font="'Noto Sans SC', sans-serif" style="min-width:auto;padding:16px;"><div style="height:60px;background:var(--card);color:var(--text);display:flex;align-items:center;justify-content:center;font-family:'Noto Sans SC';">Noto Sans</div></div>
    <div class="font-opt ripple-btn" data-font="'Fira Code', monospace" style="min-width:auto;padding:16px;"><div style="height:60px;background:var(--card);color:var(--text);display:flex;align-items:center;justify-content:center;font-family:'Fira Code';">Fira Code</div></div>
  </div>
</div>

<div id="top-bar">
  <button class="ripple-btn" id="dirBtn">ğŸ“ ç›®å½•</button>
  <div id="note-title">æœªå‘½å</div>
  <div style="display:flex;gap:8px;">
    <button class="ripple-btn" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
    <button class="ripple-btn" id="detailBtn">â„¹ï¸ è¯¦æƒ…</button>
  </div>
</div>

<div id="app-container">
  <div id="main-area">
    <aside id="sidebar" aria-hidden="true">
      <h2>æˆ‘çš„ç¬”è®°</h2>
      <div id="tagFilter"><strong class="muted">æ ‡ç­¾ï¼š</strong></div>
      <ul id="noteList"></ul>
      <div id="sidebar-footer">
        <div class="muted">ç”¨æˆ·ï¼š<span id="profileName">è®¿å®¢</span></div>
        <div class="muted">ç¬”è®°æ•°ï¼š<span id="noteCount">0</span></div>
        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
          <button class="ripple-btn" id="skinBtn" style="padding:6px 10px;font-size:0.85rem;min-width:auto;">ğŸ¨ çš®è‚¤</button>
          <button class="ripple-btn" id="fontBtn" style="padding:6px 10px;font-size:0.85rem;min-width:auto;">âœ’ï¸ å­—ä½“</button>
          <button class="ripple-btn" id="newNoteBtn" style="padding:6px 10px;font-size:0.85rem;min-width:auto;">+ æ–°ç¬”è®°</button>
          <button class="ripple-btn" id="importBtn" style="padding:6px 10px;font-size:0.85rem;min-width:auto;">â†‘ å¯¼å…¥</button>
          <button class="ripple-btn" id="logoutBtn" style="padding:6px 10px;font-size:0.85rem;min-width:auto;">é€€å‡º</button>
        </div>
      </div>
    </aside>

    <section id="editor">
      <div id="writing-area">
        <div id="noteContent" contenteditable="true" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å›å“â€¦"></div>
        <div id="previewContent"></div>
      </div>
      <div style="margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <input type="text" id="tagInput" placeholder="#çµæ„Ÿ #å­¦ä¹ ï¼ˆå¤±å»ç„¦ç‚¹è‡ªåŠ¨æ·»åŠ ï¼‰" style="flex:1;min-width:200px;" />
        <button class="ripple-btn" id="exportMdBtn">ğŸ“¥ .md</button>
      </div>
      <div id="tagDisplay" style="margin-top:14px"></div>
      <p id="status" style="font-size:0.92rem;color:var(--text);opacity:0.8;text-align:center;margin-top:12px;"></p>
    </section>

    <aside id="detailPanel" aria-hidden="true">
      <button class="ripple-btn" id="closeDetail" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:1.5rem;color:var(--text);opacity:0.7;width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0;">Ã—</button>
      <h3>ç¬”è®°è¯¦æƒ…</h3>
      <div class="detail-section">
        <h4>ğŸ“ åŸºæœ¬ä¿¡æ¯</h4>
        <div class="detail-row">
          <span class="detail-label">æ ‡é¢˜ï¼š</span>
          <span id="detailTitle" class="detail-value">â€”</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">å­—æ•°ï¼š</span>
          <span id="detailWords" class="detail-value">0</span>
        </div>
      </div>
      <div class="detail-section">
        <h4>ğŸ•’ æ—¶é—´è®°å½•</h4>
        <div class="detail-row">
          <span class="detail-label">åˆ›å»ºï¼š</span>
          <span id="detailCreated" class="detail-value">â€”</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">æœ€åä¿®æ”¹ï¼š</span>
          <span id="detailUpdated" class="detail-value">â€”</span>
        </div>
      </div>
      <div class="detail-section">
        <h4>ğŸ·ï¸ æ ‡ç­¾ä¸æ“ä½œ</h4>
        <div class="detail-row">
          <span class="detail-label">æ ‡ç­¾ï¼š</span>
          <span id="detailTags" class="detail-value">â€”</span>
        </div>
        <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="ripple-btn" id="exportNoteBtn">å¯¼å‡ºç¬”è®°</button>
          <button class="ripple-btn" id="copyBtn">å¤åˆ¶å†…å®¹</button>
        </div>
        <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">
          <div class="muted">å¿«é€Ÿæ“ä½œ</div>
          <div style="display:flex;gap:10px;margin-top:10px;">
            <button class="ripple-btn" id="pinBtn">ğŸ“Œ ç½®é¡¶</button>
            <button class="ripple-btn" id="duplicateBtn">ğŸ” å¤åˆ¶</button>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<div id="login" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:10000;background:var(--card);border:1px solid var(--border);padding:24px;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,0.1);">
  <h2 style="margin-bottom:12px">åŒ£ä¹‹å›å“</h2>
  <input id="username" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" style="width:280px;padding:10px 14px;border-radius:var(--radius);border:1px solid var(--border)" />
  <div style="margin-top:14px;display:flex;gap:10px;">
    <button class="ripple-btn" id="loginBtn">è¿›å…¥</button>
  </div>
</div>

<div class="save-toast" id="saveToast">å·²ä¿å­˜</div>

<script>
// ========== æ°´æ³¢çº¹ ==========
function addRippleEffect(element) {
  if (element._rippleAdded) return;
  element._rippleAdded = true;
  element.addEventListener('click', function(e) {
    const rect = element.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = e.clientX - rect.left - size / 2;
    const y = e.clientY - rect.top - size / 2;
    let rippleColor = 'rgba(255, 255, 255, 0.6)';
    if (document.body.getAttribute('skin') === 'dark') {
      rippleColor = 'rgba(0, 0, 0, 0.4)';
    }
    const ripple = document.createElement('span');
    ripple.classList.add('ripple');
    ripple.style.width = ripple.style.height = `${size}px`;
    ripple.style.left = `${x}px`;
    ripple.style.top = `${y}px`;
    ripple.style.background = rippleColor;
    this.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
  });
}

// ========== å…¨å±€å˜é‡ ==========
const STORAGE_KEY = 'box_resonance_v292';
let currentUser = null;
let currentNoteId = null;
let isPreviewMode = false;
let previewDebounce = null;
let activeFilterTag = null;
const SKINS = {
  default: { bg: '#f9f7f2', text: '#333', card: '#fff', border: '#ddd', primary: '#8a7f70', light: '#e8e0d0' },
  spring: { bg: '#f8f0e5', text: '#5a4a42', card: '#fff9f2', border: '#e0c9b8', primary: '#c27b7f', light: '#f0d8d6' },
  summer: { bg: '#eef7f0', text: '#2c5f2d', card: '#f8fcf9', border: '#c2e0c9', primary: '#4a9162', light: '#d1e8d5' },
  autumn: { bg: '#fef2e9', text: '#8b4513', card: '#fff8f0', border: '#e8c9a9', primary: '#d2691e', light: '#f5d8c4' },
  winter: { bg: '#f0f4f8', text: '#2c3e50', card: '#ffffff', border: '#d1d8e0', primary: '#3498db', light: '#dae6f2' },
  dark: { bg: '#1e1e20', text: '#e6e1d9', card: '#2a2a2d', border: '#444', primary: '#b8a99a', light: '#3a3a3f' },
  glass: {
    bg: 'linear-gradient(135deg, #f8fbff, #f0f4fa)',
    text: '#2c3e50',
    card: 'rgba(255, 255, 255, 0.7)',
    border: 'rgba(200, 210, 230, 0.5)',
    primary: '#5a8dde',
    light: 'rgba(230, 240, 255, 0.6)'
  }
};

// ========== âœ… ä¿®å¤ Markdown æ¸²æŸ“ ==========
function simpleMarkdownParse(text) {
  if (!text) return '';
  const lines = text.split('\n');
  let html = '';
  for (let i = 0; i < lines.length; i++) {
    let line = lines[i].trimEnd();
    if (/^#{1,6} /.test(line)) {
      const level = line.match(/^#+/)[0].length;
      const content = line.replace(/^#{1,6} /, '');
      html += `<h${level}>${escapeHtml(content)}</h${level}>\n`;
    }
    else if (/^---\s*$/.test(line)) {
      html += '<hr>\n';
    }
    else if (line === '') {
      html += '<br>\n';
    }
    else {
      let processed = escapeHtml(line);
      processed = processed.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      processed = processed.replace(/\*(.*?)\*/g, '<em>$1</em>');
      processed = processed.replace(/`(.*?)`/g, '<code>$1</code>');
      processed = processed.replace(/~(.*?)~/g, '<del>$1</del>');
      html += `<p>${processed}</p>\n`;
    }
  }
  return html.trim();
}
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ========== å·¥å…· ==========
function getAllData() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
function saveAllData(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
function getNotes() {
  const d = getAllData();
  if (!currentUser) return { notes: {}, order: [] };
  return d[currentUser] || { notes: {}, order: [] };
}
function saveNotes(notesData) {
  const d = getAllData();
  d[currentUser] = notesData;
  saveAllData(d);
}
function showStatus(msg) {
  const el = document.getElementById('status');
  if (el) {
    el.textContent = msg;
    setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 2200);
  }
}
function showSaveToast() {
  const toast = document.getElementById('saveToast');
  toast.classList.add('show');
  setTimeout(() => { toast.classList.remove('show'); }, 1500);
}
function renderTags(tags) {
  const el = document.getElementById('tagDisplay');
  if (el) {
    el.innerHTML = (tags || []).map(t =>
      `<span style="display:inline-block;padding:6px 12px;margin:4px;background:var(--light);border-radius:999px;color:var(--text)">${t}</span>`
    ).join('');
  }
}
function getToday() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

// ========== æ ¸å¿ƒåŠŸèƒ½ ==========
function createNewNote() {
  const title = prompt('è¯·è¾“å…¥ç¬”è®°æ ‡é¢˜ï¼ˆç•™ç©ºç”¨æ—¥æœŸï¼‰', getToday());
  const final = title === null ? null : (title.trim() || getToday());
  if (final === null) return;
  const id = Date.now().toString();
  const notesData = getNotes();
  notesData.notes[id] = {
    title: final,
    content: '',
    tags: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    pinned: false
  };
  notesData.order.unshift(id);
  saveNotes(notesData);
  loadNotes();
  openNote(id);
}
function deleteNoteById(id) {
  if (!id) return;
  const d = getNotes();
  delete d.notes[id];
  d.order = d.order.filter(x => x !== id);
  saveNotes(d);
  if (currentNoteId === id) {
    currentNoteId = d.order[0] || null;
    if (currentNoteId) openNote(currentNoteId);
    else {
      document.getElementById('note-title').textContent = 'æœªå‘½å';
      document.getElementById('noteContent').innerText = '';
      document.getElementById('tagDisplay').innerHTML = '';
    }
  }
  loadNotes();
  showStatus('å·²åˆ é™¤');
}
function openNote(id) {
  const d = getNotes();
  const note = d.notes[id];
  if (!note) return;
  currentNoteId = id;
  document.getElementById('note-title').textContent = note.title || 'æœªå‘½å';
  document.getElementById('noteContent').innerText = note.content || '';
  renderTags(note.tags || []);
  if (isPreviewMode) {
    document.getElementById('previewContent').innerHTML = simpleMarkdownParse(note.content || '');
  }
  highlightActiveNote();
  updateDetailPanel(note);
}
function saveCurrentNote() {
  const content = document.getElementById('noteContent').innerText;
  const d = getNotes();
  if (!currentNoteId) {
    if (content.trim() === '') return;
    const id = Date.now().toString();
    d.notes[id] = {
      title: getToday(),
      content: content,
      tags: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      pinned: false
    };
    d.order.unshift(id);
    saveNotes(d);
    loadNotes();
    openNote(id);
    showStatus('å·²ä¿å­˜');
    return;
  }
  const note = d.notes[currentNoteId];
  note.content = content;
  note.updatedAt = new Date().toISOString();
  saveNotes(d);
  if (isPreviewMode) {
    document.getElementById('previewContent').innerHTML = simpleMarkdownParse(content);
  }
  showSaveToast();
  updateDetailPanel(note);
}
function updateDetailPanel(note) {
  if (!note) return;
  document.getElementById('detailTitle').textContent = note.title || 'â€”';
  document.getElementById('detailCreated').textContent = new Date(note.createdAt).toLocaleString();
  document.getElementById('detailUpdated').textContent = new Date(note.updatedAt).toLocaleString();
  document.getElementById('detailWords').textContent = (note.content || '').replace(/\s+/g, '').length;
  document.getElementById('detailTags').textContent = (note.tags || []).join(' ');
}
function loadNotes() {
  const d = getNotes();
  const listEl = document.getElementById('noteList');
  const allTags = new Set();
  Object.values(d.notes).forEach(n => (n.tags || []).forEach(t => allTags.add(t)));
  const tagFilter = document.getElementById('tagFilter');
  if (tagFilter) {
    tagFilter.innerHTML = '<strong class="muted">æ ‡ç­¾ï¼š</strong>';
    allTags.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'tag-btn';
      if (t === activeFilterTag) btn.classList.add('active');
      btn.textContent = t;
      btn.onclick = (ev) => {
        ev.stopPropagation();
        activeFilterTag = (t === activeFilterTag) ? null : t;
        loadNotes();
      };
      tagFilter.appendChild(btn);
    });
  }
  if (listEl) {
    listEl.innerHTML = '';
    const ordered = [...d.order];
    ordered.sort((a, b) => {
      const na = d.notes[a], nb = d.notes[b];
      if (na.pinned && !nb.pinned) return -1;
      if (nb.pinned && !na.pinned) return 1;
      return 0;
    });
    ordered.forEach(id => {
      const note = d.notes[id];
      if (!note) return;
      if (activeFilterTag && !(note.tags || []).includes(activeFilterTag)) return;
      const li = document.createElement('li');
      li.className = 'note-card' + (id === currentNoteId ? ' active' : '');
      li.dataset.id = id;
      li.innerHTML = `
        <div style="font-weight:600;margin-bottom:6px;">${escapeHtml(note.title || 'æœªå‘½å')}</div>
        <div class="muted">${new Date(note.updatedAt).toLocaleString()} â€¢ ${(note.tags || []).length} æ ‡ç­¾</div>
      `;
      li.onclick = () => openNote(id);
      let longPressTimer;
      li.addEventListener('mousedown', (e) => {
        if (e.button === 0) {
          longPressTimer = setTimeout(() => {
            const menu = document.createElement('div');
            menu.className = 'delete-menu';
            menu.innerHTML = `<button>ğŸ—‘ åˆ é™¤</button>`;
            li.appendChild(menu);
            menu.querySelector('button').onclick = (ev) => {
              ev.stopPropagation();
              if (confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) {
                deleteNoteById(id);
                menu.remove();
              }
            };
          }, 600);
        }
      });
      const clearTimer = () => {
        clearTimeout(longPressTimer);
        const menu = li.querySelector('.delete-menu');
        if (menu) menu.remove();
      };
      li.addEventListener('mouseup', clearTimer);
      li.addEventListener('mouseleave', clearTimer);
      li.addEventListener('click', clearTimer);
      listEl.appendChild(li);
    });
  }
  document.getElementById('noteCount').textContent = d.order.length;
  if (!currentNoteId && d.order.length > 0) {
    openNote(d.order[0]);
  }
}
function highlightActiveNote() {
  document.querySelectorAll('.note-card').forEach(el => el.classList.remove('active'));
  const el = [...document.querySelectorAll('.note-card')].find(x => x.dataset.id === currentNoteId);
  if (el) el.classList.add('active');
}

// ========== å…¶ä»–åŠŸèƒ½ ==========
function importNote() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.md,.txt';
  input.onchange = (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      const content = ev.target.result;
      const title = prompt('ä¸ºå¯¼å…¥çš„ç¬”è®°è®¾ç½®æ ‡é¢˜ï¼š', f.name.replace(/\.(md|txt)$/i, ''));
      if (!title) return;
      const id = Date.now().toString();
      const d = getNotes();
      d.notes[id] = {
        title: title,
        content: content,
        tags: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        pinned: false
      };
      d.order.unshift(id);
      saveNotes(d);
      loadNotes();
      openNote(id);
      showStatus('å¯¼å…¥æˆåŠŸ');
    };
    r.readAsText(f);
  };
  input.click();
}

// ========== çš®è‚¤ & å­—ä½“ ==========
function applySkin(skinName) {
  const skin = SKINS[skinName] || SKINS.default;
  if (skinName === 'glass') {
    document.body.style.background = skin.bg;
  } else {
    document.documentElement.style.setProperty('--bg', skin.bg);
    document.body.style.background = '';
  }
  document.documentElement.style.setProperty('--text', skin.text);
  document.documentElement.style.setProperty('--card', skin.card);
  document.documentElement.style.setProperty('--border', skin.border);
  document.documentElement.style.setProperty('--primary', skin.primary);
  document.documentElement.style.setProperty('--light', skin.light);
  document.body.setAttribute('skin', skinName);
  localStorage.setItem('box_resonance_skin', skinName);
}
function applyFont(fontFamily) {
  document.getElementById('dynamic-font').textContent = `body, #noteContent { font-family: ${fontFamily} !important; }`;
  const noteContent = document.getElementById('noteContent');
  if (noteContent) {
    noteContent.style.fontFamily = fontFamily;
  }
  localStorage.setItem('box_resonance_font', fontFamily);
}

// ========== äº‹ä»¶ç»‘å®š ==========
document.addEventListener('DOMContentLoaded', () => {
  const savedSkin = localStorage.getItem('box_resonance_skin');
  const savedFont = localStorage.getItem('box_resonance_font');
  applySkin(savedSkin || 'default');
  applyFont(savedFont || "'Source Han Serif SC', serif");

  const savedUser = localStorage.getItem('box_resonance_user');
  if (savedUser) {
    currentUser = savedUser;
    document.getElementById('profileName').textContent = savedUser;
    document.getElementById('login').style.display = 'none';
    document.getElementById('app-container').style.display = 'block';
  } else {
    document.getElementById('login').style.display = 'block';
    document.getElementById('app-container').style.display = 'none';
  }

  setTimeout(() => {
    document.querySelectorAll('.ripple-btn').forEach(addRippleEffect);
    const observer = new MutationObserver(() => {
      document.querySelectorAll('.ripple-btn').forEach(btn => {
        if (!btn._rippleAdded) {
          addRippleEffect(btn);
          btn._rippleAdded = true;
        }
      });
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }, 100);

  document.getElementById('dirBtn').onclick = () => {
    document.getElementById('sidebar').classList.add('shown');
    document.getElementById('sidebarBackdrop').classList.add('active');
  };
  document.getElementById('detailBtn').onclick = () => {
    document.getElementById('detailPanel').classList.add('shown');
    document.getElementById('detailBackdrop').classList.add('active');
  };
  document.getElementById('closeDetail').onclick = () => {
    document.getElementById('detailPanel').classList.remove('shown');
    document.getElementById('detailBackdrop').classList.remove('active');
  };
  document.getElementById('sidebarBackdrop').onclick = (e) => { e.stopPropagation(); document.getElementById('sidebar').classList.remove('shown'); document.getElementById('sidebarBackdrop').classList.remove('active'); };
  document.getElementById('detailBackdrop').onclick = (e) => { e.stopPropagation(); document.getElementById('detailPanel').classList.remove('shown'); document.getElementById('detailBackdrop').classList.remove('active'); };
  document.getElementById('sidebar').addEventListener('click', e => e.stopPropagation());
  document.getElementById('detailPanel').addEventListener('click', e => e.stopPropagation());

  document.getElementById('note-title').onclick = () => {
    const el = document.getElementById('note-title');
    if (el.classList.contains('editing')) return;
    const original = el.textContent;
    el.classList.add('editing');
    el.contentEditable = true;
    el.focus();
    const save = () => {
      el.classList.remove('editing');
      el.contentEditable = false;
      const newTitle = el.textContent.trim() || 'æœªå‘½å';
      if (newTitle !== original && currentNoteId) {
        const d = getNotes();
        d.notes[currentNoteId].title = newTitle;
        d.notes[currentNoteId].updatedAt = new Date().toISOString();
        saveNotes(d);
        loadNotes();
        showStatus('æ ‡é¢˜å·²æ›´æ–°');
      }
    };
    el.addEventListener('blur', save);
    el.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); el.blur(); } });
  };

  const noteContent = document.getElementById('noteContent');
  const previewContent = document.getElementById('previewContent');
  function updatePreview() {
    if (isPreviewMode) {
      previewContent.innerHTML = simpleMarkdownParse(noteContent.innerText);
    }
  }
  noteContent.addEventListener('input', () => {
    clearTimeout(previewDebounce);
    previewDebounce = setTimeout(() => {
      updatePreview();
      saveCurrentNote();
    }, 300);
  });

  let previewToggleBtn = document.createElement('button');
  previewToggleBtn.className = 'ripple-btn';
  previewToggleBtn.textContent = 'ğŸ‘ é¢„è§ˆ';
  previewToggleBtn.onclick = () => {
    isPreviewMode = !isPreviewMode;
    if (isPreviewMode) {
      previewContent.style.display = 'block';
      noteContent.style.display = 'none';
      previewToggleBtn.textContent = 'ğŸ“ ç¼–è¾‘';
    } else {
      previewContent.style.display = 'none';
      noteContent.style.display = 'block';
      previewToggleBtn.textContent = 'ğŸ‘ é¢„è§ˆ';
    }
    if (isPreviewMode) updatePreview();
  };
  document.querySelector('#editor').insertBefore(previewToggleBtn, document.querySelector('#writing-area'));

  document.getElementById('tagInput').addEventListener('blur', () => {
    const input = document.getElementById('tagInput');
    const v = input.value.trim();
    if (!v || !currentNoteId) return;
    const tags = v.split(/\s+/).filter(t => t.startsWith('#')).map(t => t.trim());
    const d = getNotes();
    const note = d.notes[currentNoteId];
    if (!note) return;
    note.tags = [...new Set([...(note.tags || []), ...tags])];
    note.updatedAt = new Date().toISOString();
    saveNotes(d);
    renderTags(note.tags);
    input.value = '';
    loadNotes();
  });

  document.getElementById('newNoteBtn').onclick = createNewNote;
  document.getElementById('saveBtn').onclick = saveCurrentNote;
  document.getElementById('importBtn').onclick = importNote;
  document.getElementById('exportMdBtn').onclick = () => {
    if (!currentNoteId) { alert('æ— ç¬”è®°'); return; }
    const d = getNotes();
    const n = d.notes[currentNoteId];
    const blob = new Blob([n.content || ''], { type: 'text/markdown' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (n.title || 'æœªå‘½å') + '.md';
    document.body.appendChild(a);
    a.click();
    a.remove();
  };
  document.getElementById('copyBtn').onclick = () => {
    const text = document.getElementById('noteContent').innerText;
    navigator.clipboard.writeText(text).then(() => showStatus('å·²å¤åˆ¶'));
  };
  document.getElementById('logoutBtn').onclick = () => {
    if (confirm('é€€å‡ºï¼Ÿ')) {
      localStorage.removeItem('box_resonance_user');
      localStorage.removeItem('box_resonance_skin');
      localStorage.removeItem('box_resonance_font');
      location.reload();
    }
  };
  document.getElementById('skinBtn').onclick = () => {
    document.getElementById('skinModal').style.opacity = '1';
    document.getElementById('skinModal').style.visibility = 'visible';
    document.getElementById('skinBackdrop').classList.add('active');
  };
  document.getElementById('fontBtn').onclick = () => {
    document.getElementById('fontModal').style.opacity = '1';
    document.getElementById('fontModal').style.visibility = 'visible';
    document.getElementById('fontBackdrop').classList.add('active');
  };
  document.getElementById('skinBackdrop').onclick = () => {
    document.getElementById('skinModal').style.opacity = '0';
    document.getElementById('skinModal').style.visibility = 'hidden';
    document.getElementById('skinBackdrop').classList.remove('active');
  };
  document.getElementById('fontBackdrop').onclick = () => {
    document.getElementById('fontModal').style.opacity = '0';
    document.getElementById('fontModal').style.visibility = 'hidden';
    document.getElementById('fontBackdrop').classList.remove('active');
  };

  document.querySelectorAll('.skin-opt').forEach(el => {
    el.onclick = () => {
      const skin = el.dataset.skin;
      applySkin(skin);
      document.getElementById('skinModal').style.opacity = '0';
      document.getElementById('skinModal').style.visibility = 'hidden';
      document.getElementById('skinBackdrop').classList.remove('active');
    };
  });
  document.querySelectorAll('.font-opt').forEach(el => {
    el.onclick = () => {
      const font = el.dataset.font;
      applyFont(font);
      document.getElementById('fontModal').style.opacity = '0';
      document.getElementById('fontModal').style.visibility = 'hidden';
      document.getElementById('fontBackdrop').classList.remove('active');
    };
  });

  document.getElementById('loginBtn').onclick = () => {
    const name = document.getElementById('username').value.trim();
    if (!name) return alert('è¯·è¾“å…¥åå­—');
    currentUser = name;
    localStorage.setItem('box_resonance_user', name);
    document.getElementById('profileName').textContent = name;
    document.getElementById('login').style.display = 'none';
    document.getElementById('app-container').style.display = 'block';
    loadNotes();
  };

  window.addEventListener('load', () => {
    setTimeout(() => {
      document.getElementById('loader').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loader').style.display = 'none';
        if (currentUser) {
          document.getElementById('app-container').style.display = 'block';
          loadNotes();
        }
      }, 600);
    }, 1200);
  });
});
</script>
</body>
</html>
